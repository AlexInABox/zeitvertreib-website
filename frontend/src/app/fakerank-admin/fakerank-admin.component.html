<!-- Toast Messages -->
<div class="toast-container">
  @for (toast of toastMessages(); track toast.id) {
    <div class="toast" [class]="'toast-' + toast.severity">
      <div class="toast-icon">
        @switch (toast.severity) {
          @case ('success') {
            ‚úÖ
          }
          @case ('error') {
            ‚ùå
          }
          @case ('warn') {
            ‚ö†Ô∏è
          }
          @case ('info') {
            ‚ÑπÔ∏è
          }
        }
      </div>
      <div class="toast-content">
        <div class="toast-summary">{{ toast.summary }}</div>
        <div class="toast-detail">{{ toast.detail }}</div>
      </div>
      <button class="toast-close" (click)="removeToast(toast.id)">√ó</button>
    </div>
  }
</div>

<!-- Confirmation Dialog -->
@if (confirmationDialog().show) {
  <div class="dialog-overlay">
    <div class="dialog">
      <div class="dialog-header">
        <h3>{{ confirmationDialog().title }}</h3>
      </div>
      <div class="dialog-content">
        <p>{{ confirmationDialog().message }}</p>
      </div>
      <div class="dialog-footer">
        <button class="btn btn-secondary" (click)="confirmDialogReject()">
          Abbrechen
        </button>
        <button class="btn btn-danger" (click)="confirmDialogAccept()">
          Best√§tigen
        </button>
      </div>
    </div>
  </div>
}

<!-- Header -->
<div class="admin-header">
  <div class="container">
    <div class="header-content">
      <div>
        <h1 class="admin-title">Fakerank Administration</h1>
        <p class="admin-subtitle">Verwalte Benutzer-Fakeranks und Filter</p>
      </div>
      <a routerLink="/dashboard" class="btn btn-outline"
        >‚Üê Zur√ºck zum Dashboard</a
      >
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <div class="admin-container">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      @for (tab of TABS; track tab.id; let i = $index) {
        <button
          class="tab-button"
          [class.active]="activeTabIndex() === i"
          (click)="onTabChange(i)"
        >
          <span class="tab-icon">{{ tab.icon }}</span>
          <span class="tab-title">{{ tab.title }}</span>
        </button>
      }
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      @switch (activeTabIndex()) {
        @case (0) {
          <!-- User Management Tab -->
          <div class="tab-panel">
            <h2 class="section-title">Benutzer Fakerank verwalten</h2>

            <!-- User Search -->
            <div class="search-section">
              <div class="input-group">
                <input
                  type="text"
                  class="form-input"
                  placeholder="Steam ID eingeben (z.B. id oder id@steam)..."
                  [ngModel]="searchSteamId()"
                  (ngModelChange)="searchSteamId.set($event)"
                  (keyup.enter)="searchUser()"
                  [disabled]="loading().user"
                />
                <button
                  class="btn btn-primary"
                  (click)="searchUser()"
                  [disabled]="loading().user || !searchSteamId().trim()"
                >
                  @if (loading().user) {
                    <span class="spinner"></span>
                  } @else {
                    üîç Suchen
                  }
                </button>
              </div>
            </div>

            <!-- User Details -->
            @if (searchedUser(); as user) {
              <div class="user-card">
                <div class="user-header">
                  <img
                    [src]="getAvatarUrl(user.avatarFull)"
                    alt="Avatar"
                    class="user-avatar"
                    (error)="onAvatarError($event)"
                  />
                  <div class="user-info">
                    <h3 class="user-name">{{ user.username }}</h3>
                    <p class="user-steam-id">Steam ID: {{ user.steamId }}</p>
                    @if (user.fakerank) {
                      <p class="user-current-fakerank">
                        Aktueller Fakerank: <strong>{{ user.fakerank }}</strong>
                      </p>
                    } @else {
                      <p class="user-no-fakerank">Kein Fakerank gesetzt</p>
                    }
                  </div>
                </div>

                <!-- Fakerank Management -->
                <div class="fakerank-actions">
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-input"
                      placeholder="Neuen Fakerank eingeben..."
                      [ngModel]="newFakerank()"
                      (ngModelChange)="newFakerank.set($event)"
                      (keydown)="onKeyDown($event)"
                      [disabled]="loading().user"
                    />
                    <button
                      class="btn btn-success"
                      (click)="setUserFakerank()"
                      [disabled]="loading().user || !newFakerank().trim()"
                    >
                      @if (loading().user) {
                        <span class="spinner"></span>
                      } @else {
                        üíæ Setzen
                      }
                    </button>
                  </div>

                  <!-- Color Picker -->
                  <div class="color-picker-section">
                    <label class="color-picker-label">üé® Farbe w√§hlen</label>
                    <div class="color-picker-container">
                      <button
                        (click)="toggleColorPicker()"
                        class="color-selector-button"
                        [disabled]="loading().user"
                        type="button"
                      >
                        <span
                          class="color-indicator"
                          [style.background-color]="
                            getColorHex(tempFakerankColor())
                          "
                        ></span>
                        {{ getColorName(tempFakerankColor()) }}
                        <span class="dropdown-arrow">{{
                          showColorPicker() ? '‚ñ≤' : '‚ñº'
                        }}</span>
                      </button>

                      @if (showColorPicker()) {
                        <div class="color-picker-dropdown">
                          <div class="color-options">
                            @for (color of FAKERANK_COLORS; track color.key) {
                              <button
                                (click)="selectColor(color.key)"
                                class="color-option"
                                [class.selected]="
                                  tempFakerankColor() === color.key
                                "
                                type="button"
                              >
                                <span
                                  class="color-indicator"
                                  [style.background-color]="color.hex"
                                ></span>
                                <span class="color-name">{{ color.name }}</span>
                                @if (tempFakerankColor() === color.key) {
                                  <span class="selected-check">‚úì</span>
                                }
                              </button>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </div>

                  <!-- Override Controls -->
                  <div class="override-controls">
                    <div class="override-toggle">
                      <label class="toggle-label">
                        <input
                          type="checkbox"
                          class="toggle-input"
                          [ngModel]="isOverrideMode()"
                          (ngModelChange)="isOverrideMode.set($event)"
                          [disabled]="loading().user"
                        />
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">üîí Override-Modus</span>
                      </label>
                      <p class="override-description">
                        Override erm√∂glicht es, einem User einen Fakerank zu
                        setzen, auch wenn er normalerweise keine Berechtigung
                        dazu hat.
                      </p>
                    </div>

                    @if (isOverrideMode()) {
                      <div class="override-duration">
                        <label class="duration-label"
                          >‚è±Ô∏è Override-Dauer (Stunden):</label
                        >
                        <div class="duration-controls">
                          <button
                            type="button"
                            class="duration-btn"
                            (click)="decreaseOverrideDuration()"
                            [disabled]="
                              loading().user || overrideDurationHours() <= 1
                            "
                          >
                            -
                          </button>
                          <input
                            type="number"
                            class="duration-input"
                            [ngModel]="overrideDurationHours()"
                            (ngModelChange)="setOverrideDuration($event)"
                            min="1"
                            max="168"
                            [disabled]="loading().user"
                          />
                          <button
                            type="button"
                            class="duration-btn"
                            (click)="increaseOverrideDuration()"
                            [disabled]="
                              loading().user || overrideDurationHours() >= 168
                            "
                          >
                            +
                          </button>
                        </div>
                        <span class="duration-hint">Max: 7 Tage (168h)</span>
                      </div>
                    }
                  </div>

                  @if (user.fakerank) {
                    <button
                      class="btn btn-danger"
                      (click)="removeUserFakerank()"
                      [disabled]="loading().user"
                    >
                      @if (loading().user) {
                        <span class="spinner"></span>
                      } @else {
                        üóëÔ∏è Entfernen
                      }
                    </button>
                  }
                </div>
              </div>
            }
          </div>
        }

        @case (1) {
          <!-- Blacklist Tab -->
          <div class="tab-panel">
            <h2 class="section-title">Blacklist verwalten</h2>

            <!-- Add Word -->
            <div class="add-section">
              <div class="input-group">
                <input
                  type="text"
                  class="form-input"
                  placeholder="Wort zur Blacklist hinzuf√ºgen..."
                  [ngModel]="newBlacklistWord()"
                  (ngModelChange)="newBlacklistWord.set($event)"
                  (keydown)="onKeyDown($event)"
                  (keyup.enter)="addToBlacklist()"
                />
                <button
                  class="btn btn-primary"
                  (click)="addToBlacklist()"
                  [disabled]="!newBlacklistWord().trim()"
                >
                  ‚ûï Hinzuf√ºgen
                </button>
              </div>
            </div>

            <!-- Word List -->
            @if (loading().blacklist) {
              <div class="loading-state">
                <span class="spinner"></span>
                <span>Lade Blacklist...</span>
              </div>
            } @else {
              @if (blacklistItems().length === 0) {
                <div class="empty-state">
                  <p>Keine W√∂rter in der Blacklist</p>
                </div>
              } @else {
                <div class="items-list">
                  @for (item of blacklistItems(); track item.id) {
                    <div class="list-item">
                      <div class="item-content">
                        <span class="item-word">{{ item.word }}</span>
                        <span class="item-date">{{
                          formatDate(item.createdAt)
                        }}</span>
                      </div>
                      <button
                        class="btn btn-danger btn-sm"
                        (click)="removeFromBlacklist(item)"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  }
                </div>
              }
            }
          </div>
        }

        @case (2) {
          <!-- Whitelist Tab -->
          <div class="tab-panel">
            <h2 class="section-title">Whitelist verwalten</h2>

            <!-- Add Word -->
            <div class="add-section">
              <div class="input-group">
                <input
                  type="text"
                  class="form-input"
                  placeholder="Wort zur Whitelist hinzuf√ºgen..."
                  [ngModel]="newWhitelistWord()"
                  (ngModelChange)="newWhitelistWord.set($event)"
                  (keydown)="onKeyDown($event)"
                  (keyup.enter)="addToWhitelist()"
                />
                <button
                  class="btn btn-primary"
                  (click)="addToWhitelist()"
                  [disabled]="!newWhitelistWord().trim()"
                >
                  ‚ûï Hinzuf√ºgen
                </button>
              </div>
            </div>

            <!-- Word List -->
            @if (loading().whitelist) {
              <div class="loading-state">
                <span class="spinner"></span>
                <span>Lade Whitelist...</span>
              </div>
            } @else {
              @if (whitelistItems().length === 0) {
                <div class="empty-state">
                  <p>Keine W√∂rter in der Whitelist</p>
                </div>
              } @else {
                <div class="items-list">
                  @for (item of whitelistItems(); track item.id) {
                    <div class="list-item">
                      <div class="item-content">
                        <span class="item-word">{{ item.word }}</span>
                        <span class="item-date">{{
                          formatDate(item.createdAt)
                        }}</span>
                      </div>
                      <button
                        class="btn btn-danger btn-sm"
                        (click)="removeFromWhitelist(item)"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  }
                </div>
              }
            }
          </div>
        }

        @case (3) {
          <!-- All Fakeranks Tab -->
          <div class="tab-panel">
            <h2 class="section-title">Aktuelle Runde</h2>

            @if (loading().fakeranks) {
              <div class="loading-state">
                <span class="spinner"></span>
                <span>Lade Fakeranks...</span>
              </div>
            } @else if (allFakeranks().length === 0) {
              <div class="empty-state">
                <p>üî¥ Keine Spieler auf dem Server</p>
              </div>
            } @else {
              <!-- Statistics -->
              @if (stats().total > 0) {
                <div class="stats-section">
                  <div class="stats-grid">
                    <div class="stat-card">
                      <div class="stat-value">
                        {{ stats().currentPlayersOnline }}
                      </div>
                      <div class="stat-label">Spieler Online</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value">
                        {{ stats().uniquePlayerNames }}
                      </div>
                      <div class="stat-label">Eindeutige Spieler</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value">{{ stats().total }}</div>
                      <div class="stat-label">Fakeranks Total</div>
                    </div>
                  </div>
                </div>
              }

              <!-- Fakeranks Table -->
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Benutzername</th>
                      <th>Steam ID</th>
                      <th>Fakerank</th>
                      <th>Aktionen</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (user of allFakeranks(); track user.steamId) {
                      <tr [class.online]="user.isCurrentlyOnline">
                        <td class="user-name-cell">
                          <div class="user-info">
                            <span class="username">{{ user.username }}</span>
                            @if (user.isCurrentlyOnline) {
                              <span class="online-indicator">üü¢ Online</span>
                            }
                          </div>
                        </td>
                        <td class="steam-id-cell">{{ user.steamId }}</td>
                        <td class="fakerank-cell">
                          @if (
                            user.fakerank && user.fakerank !== 'No Fakerank'
                          ) {
                            <span
                              class="fakerank-badge"
                              [style.color]="user.fakerank_color || '#ffffff'"
                            >
                              {{ user.fakerank }}
                            </span>
                          } @else {
                            <span class="no-fakerank">No Fakerank</span>
                          }
                        </td>
                        <td>
                          <button
                            class="btn btn-outline btn-sm"
                            (click)="editFakerank(user)"
                          >
                            @if (
                              user.fakerank && user.fakerank !== 'No Fakerank'
                            ) {
                              ‚úèÔ∏è Bearbeiten
                            } @else {
                              ‚ûï Fakerank setzen
                            }
                          </button>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>

              <!-- Pagination -->
              @if (pagination().total > pagination().limit) {
                <div class="pagination">
                  <button
                    class="btn btn-outline btn-sm"
                    (click)="onPageChange(currentPage() - 2)"
                    [disabled]="currentPage() === 1"
                  >
                    ‚Üê Vorherige
                  </button>

                  <span class="pagination-info">
                    Seite {{ currentPage() }} von {{ totalPages() }} ({{
                      pagination().total
                    }}
                    Eintr√§ge gesamt)
                  </span>

                  <button
                    class="btn btn-outline btn-sm"
                    (click)="onPageChange(currentPage())"
                    [disabled]="currentPage() === totalPages()"
                  >
                    N√§chste ‚Üí
                  </button>
                </div>
              }
            }
          </div>
        }
      }
    </div>
  </div>
</div>

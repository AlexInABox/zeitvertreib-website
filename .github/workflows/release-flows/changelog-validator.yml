name: Validate Changelog

on:
  pull_request:
    types: [opened, synchronize, edited]

jobs:
  validate-changelog:
    runs-on: ubuntu-slim
    if: github.base_ref == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest_tag
        run: |
          TAG=$(git describe --tags --match 'build-*' --abbrev=0 2>/dev/null || echo "build-0")

          if [[ ! "$TAG" =~ ^build-([0-9]+)$ ]]; then
            echo "Latest tag is not in format build-<number>: $TAG"
            exit 1
          fi

          VERSION_NUMBER="${BASH_REMATCH[1]}"
          NEXT_VERSION_NUMBER=$((VERSION_NUMBER + 1))

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "next_version=$NEXT_VERSION_NUMBER" >> $GITHUB_OUTPUT


      - name: Validate changelog exists
        env:
          NEXT_VERSION: ${{ steps.latest_tag.outputs.next_version }}
        run: |
          CHANGELOG_FILE="changelog/${NEXT_VERSION}.md"
          
          if [[ ! -f "$CHANGELOG_FILE" ]]; then
            echo "❌ Changelog file not found: $CHANGELOG_FILE"
            exit 1
          fi

          # Check if file is empty
          if [[ ! -s "$CHANGELOG_FILE" ]]; then
            echo "❌ Changelog file is empty: $CHANGELOG_FILE"
            exit 1
          fi
          
          echo "✅ Changelog file found: $CHANGELOG_FILE"
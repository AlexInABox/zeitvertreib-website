<div class="m-3">
  <p-menubar [model]="items">
    <ng-template #start>
      <img id="logo-svg" src="/assets/logos/{{ inverted }}" alt="Logo" [class.logo-muted]="isMuted" />
    </ng-template>
    <ng-template #item let-item>
      <ng-container *ngIf="item.route; else urlRef">
        <a [routerLink]="item.route" class="p-menubar-item-link">
          <span [class]="item.icon"></span>
          <span class="ml-2">{{ item.label }}</span>
        </a>
      </ng-container>
      <ng-template #urlRef>
        <a
          *ngIf="item.url; else noLink"
          [href]="item.url"
          [target]="item.target || '_self'"
          class="p-menubar-item-link"
        >
          <span [class]="item.icon"></span>
          <span class="ml-2">{{ item.label }}</span>
        </a>
      </ng-template>
      <ng-template #noLink>
        <div class="p-menubar-item-link">
          <span [class]="item.icon"></span>
          <span class="ml-2">{{ item.label }}</span>
          <span class="pi pi-fw pi-angle-down ml-2"></span>
        </div>
      </ng-template>
    </ng-template>
    <ng-template #end>
      <div class="flex items-center gap-2" style="white-space: nowrap">
        <a href="https://dsc.gg/zeit" target="_blank">
          <!-- Desktop version with text -->
          <p-button label="Discord beitreten" icon="pi pi-discord" styleClass="p-button-outlined hidden sm:inline-flex">
          </p-button>
          <!-- Mobile version with icon only -->
          <p-button icon="pi pi-discord" styleClass="p-button-outlined sm:hidden"> </p-button>
        </a>
        <div class="relative inline-block mr-2" style="position:relative">
          <div style="position:relative; display:inline-block">
            <p-button (click)="toggleVolumePanel($event)" [icon]="isPlaying ? 'pi pi-volume-up' : (requiresInteraction ? 'pi pi-play' : 'pi pi-volume-off')" styleClass="p-button-outlined" [attr.title]="isPlaying ? 'Musik aus' : 'Musik an'"></p-button>
            <span *ngIf="requiresInteraction && !ctaShown" class="music-badge"></span>
          </div>
          <div class="music-popover" [class.music-popover--compact]="!isPlaying && requiresInteraction" [class.music-popover--active]="isPlaying" [class.show]="showVolumePanel" (click)="$event.stopPropagation()" [attr.aria-hidden]="!showVolumePanel" style="position:absolute; left:50%; transform:translateX(-50%); top:calc(100% + 16px); z-index:50;">
            <div class="music-popover-inner p-3">

              <!-- Compact view when autoplay blocked and not playing -->
              <div *ngIf="!isPlaying && requiresInteraction && !ctaShown" class="music-compact flex items-center justify-center">
                <p-button class="p-button-compact" (click)="enableSoundCTA()" icon="pi pi-play" styleClass="p-button-outlined"></p-button>
              </div>

              <div *ngIf="!isPlaying && requiresInteraction && ctaShown" class="music-compact flex items-center justify-center">
                <p-button class="p-button-compact" (click)="toggleMusic()" [icon]="isMuted ? 'pi pi-volume-off' : 'pi pi-play'"></p-button>
              </div>

              <!-- Compact view when paused but autoplay works -->
              <div *ngIf="!isPlaying && !requiresInteraction" class="music-compact flex items-center justify-center">
                <p-button class="p-button-compact" (click)="toggleMusic()" [icon]="isMuted ? 'pi pi-volume-off' : 'pi pi-play'"></p-button>
              </div>

              <!-- Full view when playing -->
              <div *ngIf="isPlaying" class="music-full flex flex-col items-center">
                <!-- Wrapper for visual track and smaller interactive slider -->
                <div class="vertical-slider relative flex justify-center" style="height: 100px; width: 28px;">
                  <!-- Visual Track Background -->
                  <div class="absolute rounded-full" style="width: 8px; height: 100%; top:0; left:50%; transform:translateX(-50%); background:#eef2f7; z-index:0;"></div>
                  
                  <!-- Interactive Slider (Shorter so knob stays inside visual track) -->
                  <p-slider orientation="vertical" [style]="{height: '80px', marginTop: '10px'}" [(ngModel)]="volume" [min]="0" [max]="1" [step]="0.01" (ngModelChange)="onVolumeChange($event)" aria-label="LautstÃ¤rke"></p-slider>
                </div>

                <div class="controls">
                    <p-button (click)="toggleMute()" [icon]="isMuted ? 'pi pi-volume-off' : 'pi pi-volume-up'" styleClass="p-button-outlined p-button-compact"></p-button>
                </div>
              </div>

            </div>


          </div>
        </div>
        <div class="relative profile-button-container">
          <a
            [routerLink]="userLoggedIn ? '/profile' : '/login'"
            class="relative overflow-hidden w-full border-0 bg-transparent flex items-start p-2 pl-4 rounded-xl cursor-pointer transition-colors duration-200 text-decoration-none"
          >
            <ng-container *ngIf="userLoggedIn; else showIcon">
              <p-avatar [image]="avatarIcon" class="mr-2" shape="circle" />
            </ng-container>

            <ng-template #showIcon>
              <i class="pi pi-user mr-2"></i>
              <!-- Dies ist das Symbol, das angezeigt wird, wenn nicht angemeldet -->
            </ng-template>
          </a>
        </div>
      </div>
    </ng-template>
  </p-menubar>
</div>

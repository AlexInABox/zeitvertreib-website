<!-- Toast Messages -->
<div class="toast-container">
  @for (toast of toastMessages(); track toast.id) {
    <div class="toast" [class]="'toast-' + toast.severity">
      <div class="toast-icon">
        @switch (toast.severity) {
          @case ('success') {
            âœ…
          }
          @case ('error') {
            âŒ
          }
          @case ('warn') {
            âš ï¸
          }
          @case ('info') {
            â„¹ï¸
          }
        }
      </div>
      <div class="toast-content">
        <div class="toast-summary">{{ toast.summary }}</div>
        <div class="toast-detail">{{ toast.detail }}</div>
      </div>
      <button class="toast-close" (click)="removeToast(toast.id)">Ã—</button>
    </div>
  }
</div>

<!-- Confirmation Dialog -->
@if (confirmationDialog().show) {
  <div class="dialog-overlay" (click)="confirmDialogReject()">
    <div class="dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3>{{ confirmationDialog().title }}</h3>
      </div>
      <div class="dialog-content">
        <p>{{ confirmationDialog().message }}</p>
      </div>
      <div class="dialog-footer">
        <button class="btn btn-secondary" (click)="confirmDialogReject()">
          Abbrechen
        </button>
        <button class="btn btn-danger" (click)="confirmDialogAccept()">
          BestÃ¤tigen
        </button>
      </div>
    </div>
  </div>
}

<!-- Main Container -->
<div class="admin-wrapper">
  <!-- Header Card -->
  <div class="header-card">
    <div class="header-card-content">
      <div class="header-info">
        <h1 class="header-title">
          <span class="header-icon">âš¡</span>
          Fakerank Administration
        </h1>
        <p class="header-subtitle">
          Verwalte Benutzer-Fakeranks, Filter und aktuelle Spieler
        </p>
      </div>
      <a routerLink="/dashboard" class="back-button">
        <span class="back-icon">â†</span>
        <span>Dashboard</span>
      </a>
    </div>
  </div>

  <!-- Tab Navigation Card -->
  <div class="tabs-card">
    <div class="tabs-nav">
      @for (tab of TABS; track tab.id; let i = $index) {
        <button
          class="tab-btn"
          [class.active]="activeTabIndex() === i"
          (click)="onTabChange(i)"
        >
          <span class="tab-icon">{{ tab.icon }}</span>
          <span class="tab-label">{{ tab.title }}</span>
        </button>
      }
    </div>
  </div>

  <!-- Content Area -->
  <div class="content-wrapper">
    @switch (activeTabIndex()) {
      <!-- USER MANAGEMENT TAB -->
      @case (0) {
        <div class="content-card">
          <!-- Search Section -->
          <div class="section-header">
            <h2 class="section-title">
              <span class="section-icon">ğŸ”</span>
              Benutzer suchen
            </h2>
          </div>

          <div class="search-box">
            <input
              type="text"
              class="search-input"
              placeholder="Steam ID eingeben (z.B. 76561198... oder id@steam)..."
              [ngModel]="searchSteamId()"
              (ngModelChange)="searchSteamId.set($event)"
              (keyup.enter)="searchUser()"
              [disabled]="loading().user"
            />
            <button
              class="search-btn"
              (click)="searchUser()"
              [disabled]="loading().user || !searchSteamId().trim()"
            >
              @if (loading().user) {
                <span class="spinner-small"></span>
              } @else {
                <span>ğŸ” Suchen</span>
              }
            </button>
          </div>

          <!-- User Result -->
          @if (searchedUser(); as user) {
            <div class="user-result-card">
              <div class="user-profile">
                <img
                  [src]="getAvatarUrl(user.avatarFull)"
                  alt="Avatar"
                  class="user-avatar-large"
                  (error)="onAvatarError($event)"
                />
                <div class="user-details">
                  <h3 class="user-name">{{ user.username }}</h3>
                  <p class="user-steam-id">{{ user.steamId }}</p>
                  @if (user.fakerank) {
                    <div class="current-fakerank">
                      <span class="fakerank-label">Aktueller Fakerank:</span>
                      <span
                        class="fakerank-value"
                        [style.color]="user.fakerank_color || '#ffffff'"
                      >
                        {{ user.fakerank }}
                      </span>
                    </div>
                  } @else {
                    <p class="no-fakerank-text">Kein Fakerank gesetzt</p>
                  }
                </div>
              </div>

              <!-- Edit Form -->
              <div class="edit-section">
                <div class="form-row">
                  <div class="form-group full-width">
                    <label class="form-label">Fakerank Text</label>
                    <input
                      type="text"
                      class="form-input-text"
                      placeholder="Fakerank eingeben..."
                      [ngModel]="newFakerank()"
                      (ngModelChange)="newFakerank.set($event)"
                      (keydown)="onKeyDown($event)"
                      [disabled]="loading().user"
                    />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">ğŸ¨ Farbe</label>
                    <div class="color-picker-wrapper">
                      <button
                        (click)="toggleColorPicker()"
                        class="color-btn"
                        [disabled]="loading().user"
                        type="button"
                      >
                        <span
                          class="color-dot"
                          [style.background-color]="
                            getColorHex(tempFakerankColor())
                          "
                        ></span>
                        <span class="color-text">{{
                          getColorName(tempFakerankColor())
                        }}</span>
                        <span class="color-arrow">{{
                          showColorPicker() ? 'â–²' : 'â–¼'
                        }}</span>
                      </button>

                      @if (showColorPicker()) {
                        <div class="color-dropdown">
                          @for (color of FAKERANK_COLORS; track color.key) {
                            <button
                              (click)="selectColor(color.key)"
                              class="color-option-btn"
                              [class.selected]="
                                tempFakerankColor() === color.key
                              "
                              type="button"
                            >
                              <span
                                class="color-dot"
                                [style.background-color]="color.hex"
                              ></span>
                              <span class="color-name">{{ color.name }}</span>
                              @if (tempFakerankColor() === color.key) {
                                <span class="check-icon">âœ“</span>
                              }
                            </button>
                          }
                        </div>
                      }
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">ğŸ”’ Override</label>
                    <label class="toggle-switch">
                      <input
                        type="checkbox"
                        class="toggle-checkbox"
                        [ngModel]="isOverrideMode()"
                        (ngModelChange)="isOverrideMode.set($event)"
                        [disabled]="loading().user"
                      />
                      <span class="toggle-track"></span>
                      <span class="toggle-text">
                        {{ isOverrideMode() ? 'Aktiv' : 'Inaktiv' }}
                      </span>
                    </label>
                  </div>

                  @if (isOverrideMode()) {
                    <div class="form-group">
                      <label class="form-label">â±ï¸ Dauer (Std.)</label>
                      <div class="number-input">
                        <button
                          type="button"
                          class="num-btn"
                          (click)="decreaseOverrideDuration()"
                          [disabled]="
                            loading().user || overrideDurationHours() <= 1
                          "
                        >
                          âˆ’
                        </button>
                        <input
                          type="number"
                          class="num-input"
                          [ngModel]="overrideDurationHours()"
                          (ngModelChange)="setOverrideDuration($event)"
                          min="1"
                          max="168"
                          [disabled]="loading().user"
                        />
                        <button
                          type="button"
                          class="num-btn"
                          (click)="increaseOverrideDuration()"
                          [disabled]="
                            loading().user || overrideDurationHours() >= 168
                          "
                        >
                          +
                        </button>
                      </div>
                    </div>
                  }
                </div>

                <div class="action-buttons">
                  <button
                    class="action-btn save-btn"
                    (click)="setUserFakerank()"
                    [disabled]="loading().user || !newFakerank().trim()"
                  >
                    @if (loading().user) {
                      <span class="spinner-small"></span>
                    } @else {
                      <span>ğŸ’¾ Speichern</span>
                    }
                  </button>

                  @if (user.fakerank) {
                    <button
                      class="action-btn delete-btn"
                      (click)="removeUserFakerank()"
                      [disabled]="loading().user"
                    >
                      @if (loading().user) {
                        <span class="spinner-small"></span>
                      } @else {
                        <span>ğŸ—‘ï¸ Entfernen</span>
                      }
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }

      <!-- BLACKLIST TAB -->
      @case (1) {
        <div class="content-card">
          <div class="section-header">
            <h2 class="section-title">
              <span class="section-icon">ğŸš«</span>
              Blacklist verwalten
            </h2>
          </div>

          <div class="add-word-box">
            <input
              type="text"
              class="word-input"
              placeholder="Wort zur Blacklist hinzufÃ¼gen..."
              [ngModel]="newBlacklistWord()"
              (ngModelChange)="newBlacklistWord.set($event)"
              (keydown)="onKeyDown($event)"
              (keyup.enter)="addToBlacklist()"
            />
            <button
              class="add-btn"
              (click)="addToBlacklist()"
              [disabled]="!newBlacklistWord().trim()"
            >
              â• HinzufÃ¼gen
            </button>
          </div>

          @if (loading().blacklist) {
            <div class="loading-box">
              <span class="spinner-medium"></span>
              <span>Lade Blacklist...</span>
            </div>
          } @else {
            @if (blacklistItems().length === 0) {
              <div class="empty-box">
                <span class="empty-icon">ğŸ“­</span>
                <p>Keine WÃ¶rter in der Blacklist</p>
              </div>
            } @else {
              <div class="word-grid">
                @for (item of blacklistItems(); track item.id) {
                  <div class="word-item">
                    <div class="word-info">
                      <span class="word-text">{{ item.word }}</span>
                      <span class="word-date">{{
                        formatDate(item.createdAt)
                      }}</span>
                    </div>
                    <button
                      class="remove-btn"
                      (click)="removeFromBlacklist(item)"
                    >
                      ğŸ—‘ï¸
                    </button>
                  </div>
                }
              </div>
            }
          }
        </div>
      }

      <!-- WHITELIST TAB -->
      @case (2) {
        <div class="content-card">
          <div class="section-header">
            <h2 class="section-title">
              <span class="section-icon">âœ…</span>
              Whitelist verwalten
            </h2>
          </div>

          <div class="add-word-box">
            <input
              type="text"
              class="word-input"
              placeholder="Wort zur Whitelist hinzufÃ¼gen..."
              [ngModel]="newWhitelistWord()"
              (ngModelChange)="newWhitelistWord.set($event)"
              (keydown)="onKeyDown($event)"
              (keyup.enter)="addToWhitelist()"
            />
            <button
              class="add-btn"
              (click)="addToWhitelist()"
              [disabled]="!newWhitelistWord().trim()"
            >
              â• HinzufÃ¼gen
            </button>
          </div>

          @if (loading().whitelist) {
            <div class="loading-box">
              <span class="spinner-medium"></span>
              <span>Lade Whitelist...</span>
            </div>
          } @else {
            @if (whitelistItems().length === 0) {
              <div class="empty-box">
                <span class="empty-icon">ğŸ“­</span>
                <p>Keine WÃ¶rter in der Whitelist</p>
              </div>
            } @else {
              <div class="word-grid">
                @for (item of whitelistItems(); track item.id) {
                  <div class="word-item">
                    <div class="word-info">
                      <span class="word-text">{{ item.word }}</span>
                      <span class="word-date">{{
                        formatDate(item.createdAt)
                      }}</span>
                    </div>
                    <button
                      class="remove-btn"
                      (click)="removeFromWhitelist(item)"
                    >
                      ğŸ—‘ï¸
                    </button>
                  </div>
                }
              </div>
            }
          }
        </div>
      }

      <!-- CURRENT ROUND TAB -->
      @case (3) {
        <div class="content-card">
          <div class="section-header">
            <h2 class="section-title">
              <span class="section-icon">ğŸ”´</span>
              Aktuelle Runde
              @if (!loading().fakeranks && allFakeranks().length > 0) {
                <span class="live-dot"></span>
              }
            </h2>
          </div>

          @if (loading().fakeranks) {
            <div class="loading-box">
              <span class="spinner-medium"></span>
              <span>Lade Spielerdaten...</span>
            </div>
          } @else if (allFakeranks().length === 0) {
            <div class="empty-box">
              <span class="empty-icon">ğŸ”´</span>
              <p>Keine Spieler auf dem Server</p>
            </div>
          } @else {
            <!-- Players Grid -->
            <div class="players-grid">
              @for (user of allFakeranks(); track user.steamId) {
                <div
                  class="player-card"
                  [class.online]="user.isCurrentlyOnline"
                >
                  <div class="player-header">
                    <div class="player-main">
                      <span class="player-name">{{ user.username }}</span>
                      @if (user.isCurrentlyOnline) {
                        <span class="online-badge">ğŸŸ¢ Online</span>
                      }
                    </div>
                    <span class="player-id">{{ user.steamId }}</span>
                  </div>

                  <div class="player-body">
                    @if (user.fakerank && user.fakerank !== 'No Fakerank') {
                      <div class="player-fakerank">
                        <span class="fakerank-label-sm">Fakerank:</span>
                        <span
                          class="fakerank-display"
                          [style.color]="user.fakerank_color || '#ffffff'"
                        >
                          {{ user.fakerank }}
                        </span>
                      </div>
                    } @else {
                      <div class="player-no-fakerank">
                        <span class="no-rank-text">Kein Fakerank</span>
                      </div>
                    }
                  </div>

                  <div class="player-footer">
                    <button
                      class="edit-player-btn"
                      (click)="editFakerank(user)"
                    >
                      @if (user.fakerank && user.fakerank !== 'No Fakerank') {
                        <span>âœï¸ Bearbeiten</span>
                      } @else {
                        <span>â• Setzen</span>
                      }
                    </button>
                  </div>
                </div>
              }
            </div>

            <!-- Pagination -->
            @if (pagination().total > pagination().limit) {
              <div class="pagination-bar">
                <button
                  class="page-btn"
                  (click)="onPageChange(currentPage() - 2)"
                  [disabled]="currentPage() === 1"
                >
                  â† ZurÃ¼ck
                </button>

                <span class="page-info">
                  Seite {{ currentPage() }} von {{ totalPages() }}
                  <span class="page-total"
                    >({{ pagination().total }} gesamt)</span
                  >
                </span>

                <button
                  class="page-btn"
                  (click)="onPageChange(currentPage())"
                  [disabled]="currentPage() === totalPages()"
                >
                  Weiter â†’
                </button>
              </div>
            }
          }
        </div>
      }
    }
  </div>
</div>

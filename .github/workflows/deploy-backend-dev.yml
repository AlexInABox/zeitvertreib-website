name: Deploy Backend to Dev

on:
  push:
    branches: [dev]

jobs:
  deploy:
    name: ðŸš€ Deploy backend (DEV)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Prepare environment
        run: cp .env.example .env

      - name: Verify Wrangler types
        run: npx wrangler types -e dev

      - name: Test build with code schema
        run: npx tsc

      - name: Pull real database schema
        run: |
          NODE_ENV=production npx drizzle-kit pull
          sed -i 's/\\\\\"1970-01-01T00:00:00.000Z\\\\\"/0/g' drizzle/schema.ts

      - name: Test build with real schema
        run: |
          mv src/db/schema.ts src/db/schema.ts.back
          cp drizzle/schema.ts src/db/schema.ts
          npx tsc
          mv src/db/schema.ts.back src/db/schema.ts

      - name: Final build
        run: npx tsc

      - name: Deploy to Cloudflare (dev)
        run: npx wrangler deploy -e dev

<div class="accounting-container">
  <!-- Header with Admin Controls -->
  <div class="header-section">
    <h2 class="page-title">Server-Finanzen</h2>

    <div *ngIf="isAdmin" class="admin-controls">
      <button class="admin-btn primary" (click)="openAddTransactionModal()">
        <i class="pi pi-plus"></i>
        Transaktion
      </button>
      <button class="admin-btn secondary" (click)="openAddRecurringModal()">
        <i class="pi pi-refresh"></i>
        Wiederkehrend
      </button>
    </div>
  </div>

  <!-- Main Stats Grid -->
  <div class="main-stats">
    <!-- Current Balance -->
    <div class="stat-card primary" [class.negative]="currentBalance < 0">
      <div class="stat-header">
        <i class="pi pi-wallet"></i>
        <span>Aktueller Saldo</span>
      </div>
      <div class="stat-value">
        <span class="amount">{{ currentBalance | number: '1.2-2' }}€</span>
        <span class="status" [class.positive]="currentBalance >= 0" [class.negative]="currentBalance < 0">
          {{ currentBalance >= 0 ? 'Überschuss' : 'Defizit' }}
        </span>
      </div>
    </div>

    <!-- Monthly Summary -->
    <div class="stat-card">
      <div class="stat-header">
        <i class="pi pi-calendar"></i>
        <span>Dieser Monat</span>
      </div>
      <div class="monthly-summary">
        <div class="summary-item positive">
          <span class="label">Einnahmen</span>
          <span class="value">+{{ monthlyIncome | number: '1.2-2' }}€</span>
        </div>
        <div class="summary-item negative">
          <span class="label">Ausgaben</span>
          <span class="value">-{{ monthlyExpenses | number: '1.2-2' }}€</span>
        </div>
        <div class="summary-item neutral">
          <span class="label">Bilanz</span>
          <span class="value">{{ monthlyIncome - monthlyExpenses | number: '1.2-2' }}€</span>
        </div>
      </div>
    </div>

    <!-- Coverage Status -->
    <div class="stat-card">
      <div class="stat-header">
        <i class="pi pi-chart-pie"></i>
        <span>Kostendeckung</span>
      </div>
      <div class="coverage-display">
        <div class="coverage-circle" [style.--percentage]="coveragePercentage + '%'">
          <span class="percentage">{{ coveragePercentage | number: '1.0-0' }}%</span>
        </div>
        <span class="coverage-label" [class.covered]="coveragePercentage >= 100">
          {{ coveragePercentage >= 100 ? 'Gedeckt' : 'Unterdeckt' }}
        </span>
      </div>
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="transactions-section">
    <div class="section-header">
      <h3>Letzte Transaktionen</h3>
      <div class="filter-buttons">
        <button class="filter-btn" [class.active]="currentFilter === 'all'" (click)="filterTransactions('all')">
          Alle
        </button>
        <button class="filter-btn" [class.active]="currentFilter === 'income'" (click)="filterTransactions('income')">
          Einnahmen
        </button>
        <button
          class="filter-btn"
          [class.active]="currentFilter === 'expenses'"
          (click)="filterTransactions('expenses')"
        >
          Ausgaben
        </button>
      </div>
    </div>

    <div class="transactions-list">
      <div
        class="transaction-item"
        *ngFor="let event of filteredEvents | slice: 0 : 5"
        [class.income]="event.type === 'income'"
        [class.expense]="event.type === 'expense'"
      >
        <div class="transaction-info">
          <div class="transaction-main">
            <span class="service-name">{{ event.service }}</span>
            <span
              class="transaction-amount"
              [class.positive]="event.type === 'income'"
              [class.negative]="event.type === 'expense'"
            >
              {{ event.type === 'income' ? '+' : '-' }}{{ event.amount | number: '1.2-2' }}€
            </span>
          </div>
          <div class="transaction-details">
            <span class="description">{{ event.description }}</span>
            <span class="date">{{ event.date | date: 'dd.MM.yyyy' }}</span>
          </div>
        </div>

        <div *ngIf="isAdmin" class="admin-actions">
          <button class="action-btn edit" (click)="editTransaction(event)" title="Bearbeiten">
            <i class="pi pi-pencil"></i>
          </button>
          <button class="action-btn delete" (click)="deleteTransaction(event)" title="Löschen">
            <i class="pi pi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Projection -->
  <div class="projection-section">
    <h3>Prognose</h3>
    <div class="projection-cards">
      <div class="projection-card">
        <span class="projection-label">Nächste 3 Monate</span>
        <span
          class="projection-value"
          [class.positive]="threeMonthProjection >= 0"
          [class.negative]="threeMonthProjection < 0"
        >
          {{ threeMonthProjection >= 0 ? '+' : '' }}{{ threeMonthProjection | number: '1.2-2' }}€
        </span>
      </div>
      <div class="projection-card">
        <span class="projection-label">Laufzeit bei akt. Saldo</span>
        <span class="projection-value">{{ burnRate | number: '1.0-0' }} Monate</span>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Modal -->
<div *ngIf="showTransactionModal" class="modal-overlay" (click)="closeTransactionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        {{ editingTransaction ? 'Transaktion bearbeiten' : 'Neue Transaktion' }}
      </h3>
      <button class="modal-close" (click)="closeTransactionModal()">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <form class="transaction-form" (ngSubmit)="saveTransaction()" #transactionForm="ngForm">
      <div class="form-row">
        <div class="form-group">
          <label>Typ</label>
          <select [(ngModel)]="transactionFormData.type" name="type" required>
            <option value="">Auswählen</option>
            <option value="income">Einnahme</option>
            <option value="expense">Ausgabe</option>
          </select>
        </div>
        <div class="form-group">
          <label>Betrag (€)</label>
          <input
            type="number"
            [(ngModel)]="transactionFormData.amount"
            name="amount"
            required
            step="0.01"
            min="0"
            placeholder="0.00"
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Kategorie</label>
          <select [(ngModel)]="transactionFormData.category" name="category" required>
            <option value="">Auswählen</option>
            <option value="hosting">Server-Hosting</option>
            <option value="domain">Domain</option>
            <option value="services">Services</option>
            <option value="donation">Spende</option>
            <option value="merchandise">Merchandise</option>
            <option value="other">Sonstiges</option>
          </select>
        </div>
        <div class="form-group">
          <label>Datum</label>
          <input type="date" [(ngModel)]="transactionFormData.date" name="date" required />
        </div>
      </div>

      <div class="form-group full-width">
        <label>Titel</label>
        <input
          type="text"
          [(ngModel)]="transactionFormData.title"
          name="title"
          required
          placeholder="Anbieter oder Titel"
        />
      </div>

      <div class="form-group full-width">
        <label>Beschreibung</label>
        <input
          type="text"
          [(ngModel)]="transactionFormData.description"
          name="description"
          required
          placeholder="Kurze Beschreibung"
        />
      </div>

      <div class="form-actions">
        <button type="button" class="btn secondary" (click)="closeTransactionModal()">Abbrechen</button>
        <button type="submit" class="btn primary" [disabled]="!transactionForm.valid || isSubmitting">
          <i class="pi pi-spin pi-spinner" *ngIf="isSubmitting"></i>
          {{ editingTransaction ? 'Speichern' : 'Hinzufügen' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Recurring Transaction Modal -->
<div *ngIf="showRecurringModal" class="modal-overlay" (click)="closeRecurringModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        {{ editingRecurring ? 'Wiederkehrende Transaktion bearbeiten' : 'Neue wiederkehrende Transaktion' }}
      </h3>
      <button class="modal-close" (click)="closeRecurringModal()">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <form class="transaction-form" (ngSubmit)="saveRecurringTransaction()" #recurringForm="ngForm">
      <div class="form-row">
        <div class="form-group">
          <label>Typ</label>
          <select [(ngModel)]="recurringFormData.type" name="type" required>
            <option value="">Auswählen</option>
            <option value="income">Einnahme</option>
            <option value="expense">Ausgabe</option>
          </select>
        </div>
        <div class="form-group">
          <label>Betrag (€)</label>
          <input
            type="number"
            [(ngModel)]="recurringFormData.amount"
            name="amount"
            required
            step="0.01"
            min="0"
            placeholder="0.00"
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Kategorie</label>
          <select [(ngModel)]="recurringFormData.category" name="category" required>
            <option value="">Auswählen</option>
            <option value="hosting">Server-Hosting</option>
            <option value="domain">Domain</option>
            <option value="services">Services</option>
            <option value="donation">Spende</option>
            <option value="merchandise">Merchandise</option>
            <option value="other">Sonstiges</option>
          </select>
        </div>
        <div class="form-group">
          <label>Häufigkeit</label>
          <select [(ngModel)]="recurringFormData.frequency" name="frequency" required>
            <option value="">Auswählen</option>
            <option value="monthly">Monatlich</option>
            <option value="yearly">Jährlich</option>
            <option value="weekly">Wöchentlich</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Startdatum</label>
          <input type="date" [(ngModel)]="recurringFormData.start_date" name="start_date" required />
        </div>
        <div class="form-group">
          <label>Enddatum (optional)</label>
          <input type="date" [(ngModel)]="recurringFormData.end_date" name="end_date" />
        </div>
      </div>

      <div class="form-group full-width">
        <label>Titel</label>
        <input
          type="text"
          [(ngModel)]="recurringFormData.title"
          name="title"
          required
          placeholder="Anbieter oder Titel"
        />
      </div>

      <div class="form-group full-width">
        <label>Beschreibung</label>
        <input
          type="text"
          [(ngModel)]="recurringFormData.description"
          name="description"
          required
          placeholder="Kurze Beschreibung"
        />
      </div>

      <div class="form-actions">
        <button type="button" class="btn secondary" (click)="closeRecurringModal()">Abbrechen</button>
        <button type="submit" class="btn primary" [disabled]="!recurringForm.valid || isSubmitting">
          <i class="pi pi-spin pi-spinner" *ngIf="isSubmitting"></i>
          {{ editingRecurring ? 'Speichern' : 'Hinzufügen' }}
        </button>
      </div>
    </form>
  </div>
</div>

<div class="profile-page">
  <!-- Loading State -->
  <div *ngIf="!currentUser" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Lade Profildaten...</p>
  </div>

  <div *ngIf="currentUser" class="profile-wrapper">
    <!-- Profile Card -->
    <div class="card profile-card">
      <div class="card-header">
        <span class="card-icon">ğŸ‘¤</span>
        <div class="card-title-group">
          <h2>Profil</h2>
          <span class="card-subtitle">Deine Account-Informationen</span>
        </div>
      </div>
      <div class="profile-content">
        <img [src]="currentUser.avatarUrl" [alt]="currentUser.username" class="avatar" />
        <div class="profile-info">
          <span class="username">{{ currentUser.username }}</span>
          <span class="steamid">{{ currentUser.steamId }}</span>
        </div>
        <button class="btn btn-danger" (click)="logout()"><span>ğŸšª</span> Abmelden</button>
      </div>
    </div>

    <!-- Sessions Card -->
    <div class="card sessions-card">
      <div class="card-header">
        <span class="card-icon">ğŸ”</span>
        <div class="card-title-group">
          <h2>Aktive Sitzungen</h2>
          <span class="card-subtitle">Verwalte deine aktiven GerÃ¤te</span>
        </div>
        <span *ngIf="sessions.length > 0" class="badge">{{ sessions.length }}</span>
      </div>

      <!-- Loading -->
      <div *ngIf="loadingSessions" class="card-loading">
        <div class="loading-spinner small"></div>
        <span>Lade Sitzungen...</span>
      </div>

      <!-- Sessions Content -->
      <div *ngIf="!loadingSessions && sessions.length > 0" class="sessions-content">
        <button class="ip-toggle" (click)="toggleIps()">
          {{ showIps ? 'ğŸ™ˆ IPs verbergen' : 'ğŸ‘ï¸ IPs anzeigen' }}
        </button>

        <div class="sessions-list">
          <div
            *ngFor="let session of sessions"
            class="session-row"
            [class.current]="isCurrentSession(session.id)"
            [class.stale]="!isCurrentSession(session.id) && isStale(session.lastLoginAt)"
          >
            <span class="session-icon">{{ getDeviceIcon(session.userAgent) }}</span>
            <div class="session-details">
              <div class="session-main">
                <span class="session-browser">{{ getBrowserName(session.userAgent) }}</span>
                <span *ngIf="isCurrentSession(session.id)" class="tag tag-current">Aktuell</span>
                <span *ngIf="!isCurrentSession(session.id) && isStale(session.lastLoginAt)" class="tag tag-stale"
                  >Inaktiv</span
                >
              </div>
              <span class="session-ip">{{ getIpDisplay(session.ipAddress) }}</span>
              <div class="session-time">
                <span [class.text-warning]="isStale(session.lastLoginAt)">{{
                  getRelativeTime(session.lastLoginAt)
                }}</span>
                <span class="dot">Â·</span>
                <span>{{ formatDate(session.createdAt) }}</span>
              </div>
            </div>
            <button
              *ngIf="!isCurrentSession(session.id)"
              class="btn-icon-only btn-revoke"
              (click)="revokeSession(session.id)"
              [disabled]="revokingSession === session.id"
              title="Sitzung beenden"
            >
              <span *ngIf="revokingSession !== session.id">ğŸ—‘ï¸</span>
              <span *ngIf="revokingSession === session.id" class="loading-spinner tiny"></span>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty -->
      <div *ngIf="!loadingSessions && sessions.length === 0" class="card-empty">
        <span>ğŸ”’</span>
        <span>Keine aktiven Sitzungen</span>
      </div>
    </div>

    <!-- Data Management Card -->
    <div class="card data-card">
      <div class="card-header">
        <span class="card-icon">ğŸ“Š</span>
        <div class="card-title-group">
          <h2>Datenverwaltung</h2>
          <span class="card-subtitle">Kontrolliere deine persÃ¶nlichen Daten</span>
        </div>
      </div>
      <div class="data-buttons">
        <button class="data-btn" [disabled]="isTakeoutDisabled()" (click)="openTakeoutModal()">
          <span class="data-btn-icon">ğŸ“¥</span>
          <div class="data-btn-text">
            <span class="data-btn-title">Daten exportieren</span>
            <span class="data-btn-desc" *ngIf="!isTakeoutDisabled()">Lade alle deine Daten herunter</span>
            <span class="data-btn-desc" *ngIf="isTakeoutDisabled() && lastTakeoutAt > 0">
              Zuletzt angefordert: {{ formatDate(lastTakeoutAt) }}
            </span>
          </div>
          <span class="tag tag-cooldown" *ngIf="isTakeoutDisabled() && lastTakeoutAt > 0">
            {{ getDaysUntilNextTakeout() }} Tage
          </span>
        </button>

        <!-- Deletion Toggle -->
        <div
          class="toggle-container toggle-danger"
          [class.disabled]="deletionLoading"
          (click)="!deletionLoading && (isDeletionEnabled() ? disableDeletion() : openDeletionModal())"
        >
          <div class="toggle-content">
            <span class="toggle-icon">ğŸ—‘ï¸</span>
            <div class="toggle-text">
              <span class="toggle-title">Account lÃ¶schen</span>
              <span class="toggle-desc" *ngIf="!isDeletionEnabled()">Markiere deinen Account zur LÃ¶schung</span>
              <span class="toggle-desc" *ngIf="isDeletionEnabled()">
                Aktiviert am {{ formatDate(deletionEnabledAt) }}
              </span>
            </div>
          </div>
          <div class="toggle-switch" [class.disabled]="deletionLoading">
            <input type="checkbox" [checked]="isDeletionEnabled()" [disabled]="deletionLoading" tabindex="-1" />
            <span class="toggle-slider"></span>
          </div>
        </div>

        <!-- Deletion Instructions (shown when enabled) -->
        <div class="deletion-instructions" *ngIf="isDeletionEnabled()">
          <p class="deletion-instructions-title">ğŸ“§ NÃ¤chster Schritt:</p>
          <p class="deletion-instructions-text">
            Behalte diesen Toggle aktiviert und sende eine E-Mail an
            <a
              href="mailto:support@zeitvertreib.vip?subject=Account%20Deletion%20Request&body=User%20ID:%20{{
                getUserId()
              }}"
              >support&#64;zeitvertreib.vip</a
            >
            mit deiner User-ID:
          </p>
          <div class="userid-box">
            <code>{{ getUserId() }}</code>
          </div>
          <p class="deletion-instructions-hint">
            Unser Team prÃ¼ft deine Anfrage innerhalb von 30 Tagen. Wenn dein Toggle hier aktiviert ist, werden alle
            deine Daten unwiderruflich gelÃ¶scht. Du erhÃ¤ltst eine BestÃ¤tigung per E-Mail.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Takeout Modal -->
<div class="modal-overlay" *ngIf="showTakeoutModal" (click)="closeTakeoutModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ“¥ Daten exportieren</h3>
      <button class="modal-close" (click)="closeTakeoutModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="takeout-success" *ngIf="takeoutSuccess">
        <span class="success-icon">âœ…</span>
        <p>Deine Daten wurden erfolgreich angefordert!</p>
        <p class="success-hint">Du erhÃ¤ltst in KÃ¼rze eine E-Mail mit deinen Daten.</p>
      </div>
      <div *ngIf="!takeoutSuccess">
        <p class="modal-description">
          Wir senden dir eine E-Mail mit all deinen gespeicherten Daten als JSON-Datei. Dies beinhaltet
          Spielstatistiken, Sitzungsdaten, Uploads und mehr.
        </p>
        <div class="form-group">
          <label for="takeout-email">E-Mail-Adresse</label>
          <input
            type="email"
            id="takeout-email"
            [(ngModel)]="takeoutEmail"
            placeholder="deine@email.de"
            [disabled]="takeoutLoading"
            (keyup.enter)="submitTakeout()"
          />
        </div>
        <div class="takeout-error" *ngIf="takeoutError">
          {{ takeoutError }}
        </div>
        <p class="modal-hint">âš ï¸ Du kannst nur alle 30 Tage einen Export anfordern.</p>
      </div>
    </div>
    <div class="modal-footer" *ngIf="!takeoutSuccess">
      <button class="btn btn-secondary" (click)="closeTakeoutModal()" [disabled]="takeoutLoading">Abbrechen</button>
      <button class="btn btn-primary" (click)="submitTakeout()" [disabled]="takeoutLoading || !takeoutEmail">
        <span *ngIf="!takeoutLoading">Export anfordern</span>
        <span *ngIf="takeoutLoading">Wird gesendet...</span>
      </button>
    </div>
  </div>
</div>

<!-- Deletion Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeletionModal" (click)="closeDeletionModal()">
  <div class="modal-content modal-danger" (click)="$event.stopPropagation()">
    <div class="modal-header modal-header-danger">
      <h3>âš ï¸ Account zur LÃ¶schung markieren</h3>
      <button class="modal-close" (click)="closeDeletionModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="warning-box">
        <p><strong>Bist du sicher?</strong></p>
        <p>
          Wenn du diesen Toggle aktivierst, kann dein Account und alle damit verbundenen Daten
          <strong>jederzeit unwiderruflich gelÃ¶scht</strong> werden, sobald du eine LÃ¶schanfrage per E-Mail sendest.
        </p>
      </div>
      <p class="modal-description">Dies beinhaltet:</p>
      <ul class="deletion-list">
        <li>Alle Spielstatistiken und Fortschritte</li>
        <li>Deine ZVCoins und Transaktionshistorie</li>
        <li>Alle hochgeladenen Sprays und Fakeranks</li>
        <li>Discord-VerknÃ¼pfungen und Sitzungsdaten</li>
        <li>SÃ¤mtliche anderen gespeicherten Daten</li>
      </ul>
      <p class="modal-hint-danger">âš ï¸ Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeletionModal()" [disabled]="deletionLoading">Abbrechen</button>
      <button class="btn btn-danger" (click)="confirmEnableDeletion()" [disabled]="deletionLoading">
        <span *ngIf="!deletionLoading">Ja, zur LÃ¶schung markieren</span>
        <span *ngIf="deletionLoading">Wird aktiviert...</span>
      </button>
    </div>
  </div>
</div>

name: Build and Deploy (Dev)

on:
    push:
        branches:
            - "**"
            - "!main"

permissions:
    contents: read

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # ============================================
    # DETECT CHANGES - Determine what to build
    # ============================================
    detect-changes:
        name: ðŸ” Detect Changes
        runs-on: ubuntu-latest
        timeout-minutes: 5
        outputs:
            types: ${{ steps.filter.outputs.types }}
            frontend: ${{ steps.filter.outputs.frontend }}
            backend: ${{ steps.filter.outputs.backend }}
            overwatch: ${{ steps.filter.outputs.overwatch }}
            plugins-solution: ${{ steps.filter.outputs.plugins-solution }}
            specific-plugins: ${{ steps.find-plugins.outputs.plugins }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Check path filters
              uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      types:
                        - 'types/**'
                      frontend:
                        - 'frontend/**'
                      backend:
                        - 'backend/**'
                      overwatch:
                        - 'overwatch/**'
                      plugins-solution:
                        - 'zeitvertreibplugins.sln'
                      any-plugin:
                        - '[A-Z]*/**'

            - name: Find changed plugins
              id: find-plugins
              run: |
                  # Get list of changed files
                  CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

                  # Find changed plugin directories (start with capital letter)
                  PLUGINS=$(echo "$CHANGED_FILES" | grep -E '^[A-Z][^/]*/' | cut -d'/' -f1 | sort -u || true)

                  # Convert to JSON array of .csproj paths
                  PLUGIN_PROJECTS=""
                  for plugin in $PLUGINS; do
                    if [ -f "$plugin/$plugin.csproj" ]; then
                      PLUGIN_PROJECTS="$PLUGIN_PROJECTS\"$plugin/$plugin.csproj\","
                    fi
                  done

                  # Remove trailing comma and wrap in array
                  if [ -n "$PLUGIN_PROJECTS" ]; then
                    PLUGIN_PROJECTS="[${PLUGIN_PROJECTS%,}]"
                  else
                    PLUGIN_PROJECTS="[]"
                  fi

                  echo "plugins=$PLUGIN_PROJECTS" >> $GITHUB_OUTPUT
                  echo "Changed plugins: $PLUGIN_PROJECTS"

    # ============================================
    # BUILD JOBS - Run conditionally based on changes
    # ============================================

    build-types:
        name: ðŸ”¨ Build Types
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.types == 'true'
        timeout-minutes: 10
        defaults:
            run:
                working-directory: types

        steps:
            - name: Checkout repo
              uses: actions/checkout@v6

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: "npm"
                  cache-dependency-path: types/package-lock.json

            - name: Install dependencies
              run: npm install

            - name: Build
              run: npm run build

            - name: Upload types artifact
              uses: actions/upload-artifact@v6
              with:
                  name: types-dist
                  path: types/dist/

    build-frontend:
        name: ðŸ”¨ Build Frontend
        runs-on: ubuntu-latest
        needs: detect-changes
        # Build if types changed OR frontend changed
        if: |
            needs.detect-changes.outputs.types == 'true' ||
            needs.detect-changes.outputs.frontend == 'true'
        timeout-minutes: 15
        defaults:
            run:
                working-directory: frontend

        steps:
            - name: Checkout repo
              uses: actions/checkout@v6

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Build shared types
              working-directory: types
              run: npm install && npm run build

            - name: Install dependencies
              run: npm install

            - name: Build (dev)
              run: npm run build:dev

    build-backend:
        name: ðŸ”¨ Build Backend
        runs-on: ubuntu-latest
        needs: detect-changes
        # Build if types changed OR backend changed
        if: |
            needs.detect-changes.outputs.types == 'true' ||
            needs.detect-changes.outputs.backend == 'true'
        timeout-minutes: 15
        defaults:
            run:
                working-directory: backend
        env:
            CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
            CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

        steps:
            - name: Checkout repo
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: "npm"
                  cache-dependency-path: backend/package-lock.json

            - name: Build shared types
              working-directory: types
              run: npm install && npm run build

            - name: Install dependencies
              run: npm install

            - name: Prepare environment
              run: cp .env.example .env

            - name: Verify Wrangler types
              run: npx wrangler types -e dev

            - name: Test build with code schema
              run: npx tsc

            - name: Pull real database schema
              run: NODE_ENV=production npx drizzle-kit pull

            - name: Test build with real schema
              run: |
                  mv src/db/schema.ts src/db/schema.ts.back
                  cp drizzle/schema.ts src/db/schema.ts
                  npx tsc
                  mv src/db/schema.ts.back src/db/schema.ts

            - name: Final build
              run: npx tsc

    build-overwatch:
        name: ðŸ”¨ Build Overwatch
        runs-on: ubuntu-latest
        needs: detect-changes
        # Build if types changed OR overwatch changed
        if: |
            needs.detect-changes.outputs.types == 'true' ||
            needs.detect-changes.outputs.overwatch == 'true'
        timeout-minutes: 15
        steps:
            - uses: actions/checkout@v6

            - uses: docker/setup-buildx-action@v2

            - name: Build Docker image (no push)
              uses: docker/build-push-action@v4
              with:
                  context: .
                  file: overwatch/Dockerfile
                  push: false
                  tags: zeitvertreib-overwatch:test

    discover-all-plugins:
        name: ðŸ” Discover All C# Plugins
        runs-on: ubuntu-latest
        needs: detect-changes
        # Only discover all plugins if types changed OR solution changed
        if: |
            needs.detect-changes.outputs.types == 'true' ||
            needs.detect-changes.outputs.plugins-solution == 'true'
        timeout-minutes: 5
        outputs:
            projects: ${{ steps.set-projects.outputs.projects }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Find all csproj files (excluding root)
              id: set-projects
              run: |
                  projects=$(find . -mindepth 2 -name "*.csproj" -printf '%P\n' | jq -R -s -c 'split("\n")[:-1]')
                  echo "projects=$projects" >> $GITHUB_OUTPUT

    build-all-plugins:
        name: ðŸ”¨ Build All C# Plugins
        needs: [detect-changes, discover-all-plugins, build-types]
        if: |
            always() &&
            (needs.detect-changes.outputs.types == 'true' ||
             needs.detect-changes.outputs.plugins-solution == 'true') &&
            (needs.build-types.result == 'success' || needs.build-types.result == 'skipped')
        strategy:
            fail-fast: false
            matrix:
                plugin: ${{ fromJson(needs.discover-all-plugins.outputs.projects) }}
        uses: ./.github/workflows/build-plugin-reusable.yml
        with:
            plugin: ${{ matrix.plugin }}

    build-specific-plugins:
        name: ðŸ”¨ Build Changed C# Plugins
        needs: [detect-changes, build-types]
        if: |
            always() &&
            needs.detect-changes.outputs.types != 'true' &&
            needs.detect-changes.outputs.plugins-solution != 'true' &&
            needs.detect-changes.outputs.specific-plugins != '[]' &&
            (needs.build-types.result == 'success' || needs.build-types.result == 'skipped')
        strategy:
            fail-fast: false
            matrix:
                plugin: ${{ fromJson(needs.detect-changes.outputs.specific-plugins) }}
        uses: ./.github/workflows/build-plugin-reusable.yml
        with:
            plugin: ${{ matrix.plugin }}

    # ============================================
    # DEPLOY JOBS - Only run on dev branch
    # ============================================

    deploy-frontend:
        name: ðŸš€ Deploy Frontend (Dev)
        runs-on: ubuntu-latest
        needs: [detect-changes, build-frontend]
        if: |
            always() &&
            github.ref == 'refs/heads/dev' &&
            (needs.detect-changes.outputs.types == 'true' || needs.detect-changes.outputs.frontend == 'true') &&
            needs.build-frontend.result == 'success'
        timeout-minutes: 15
        defaults:
            run:
                working-directory: frontend
        env:
            CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
            CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

        steps:
            - name: Checkout repo
              uses: actions/checkout@v6

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Download types artifact
              uses: actions/download-artifact@v7
              with:
                  name: types-dist
                  path: types/dist

            - name: Install dependencies
              run: npm install

            - name: Build (dev)
              run: npm run build:dev

            - name: Deploy to Cloudflare (dev)
              run: npx wrangler deploy -e dev

    deploy-backend:
        name: ðŸš€ Deploy Backend (Dev)
        runs-on: ubuntu-latest
        needs: [detect-changes, build-backend]
        if: |
            always() &&
            github.ref == 'refs/heads/dev' &&
            (needs.detect-changes.outputs.types == 'true' || needs.detect-changes.outputs.backend == 'true') &&
            needs.build-backend.result == 'success'
        timeout-minutes: 15
        defaults:
            run:
                working-directory: backend
        env:
            CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
            CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

        steps:
            - name: Checkout repo
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: "npm"
                  cache-dependency-path: backend/package-lock.json

            - name: Download types artifact
              uses: actions/download-artifact@v7
              with:
                  name: types-dist
                  path: types/dist

            - name: Install dependencies
              run: npm install

            - name: Prepare environment
              run: cp .env.example .env

            - name: Build
              run: npx tsc

            - name: Deploy to Cloudflare (dev)
              run: npx wrangler deploy -e dev

    deploy-overwatch:
        name: ðŸš€ Deploy Overwatch (Dev)
        runs-on: ubuntu-latest
        needs: [detect-changes, build-overwatch]
        if: |
            always() &&
            github.ref == 'refs/heads/dev' &&
            (needs.detect-changes.outputs.types == 'true' || needs.detect-changes.outputs.overwatch == 'true') &&
            needs.build-overwatch.result == 'success'
        timeout-minutes: 20
        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v6

            - uses: docker/setup-buildx-action@v2

            - name: Login to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.repository_owner }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  file: overwatch/Dockerfile
                  push: true
                  tags: ghcr.io/${{ github.repository_owner }}/zeitvertreib-overwatch:dev

name: Build and Deploy

on:
  push:
    branches: ["**"]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================
  # BUILD JOBS - Run in parallel to verify all builds pass
  # ============================================

  build-types:
    name: ðŸ”¨ Build Types
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: types

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: types/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

  discover-plugins:
    name: ðŸ” Discover C# Plugins
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.set-projects.outputs.projects }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Find all csproj files (excluding root)
        id: set-projects
        run: |
          projects=$(find . -mindepth 2 -name "*.csproj" -printf '%P\n' | jq -R -s -c 'split("\n")[:-1]')
          echo "projects=$projects" >> $GITHUB_OUTPUT

  build-plugins:
    name: ðŸ”¨ Build C# Plugins
    needs: [build-types, discover-plugins]
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJson(needs.discover-plugins.outputs.projects) }}
    env:
      REFERENCES_URL: https://dev.zeitvertreib.vip/assets/buildtools/scpsl-references.zip
      EXILED_REFERENCES: ${{ github.workspace }}/References
      AUDIO_PLAYER_API_URL: https://github.com/Killers0992/AudioPlayerApi/releases/download/1.1.2/dependencies.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: types/package-lock.json

      - name: Build shared types
        working-directory: types
        run: |
          npm install
          npm run build

      - name: Restore NuGet packages
        run: nuget restore ${{ matrix.plugin }}

      - name: Download dependencies
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri $env:REFERENCES_URL -OutFile "$env:GITHUB_WORKSPACE/Dev.zip"
          Expand-Archive -Path "$env:GITHUB_WORKSPACE/Dev.zip" -DestinationPath $env:EXILED_REFERENCES

          Invoke-WebRequest -Uri $env:AUDIO_PLAYER_API_URL -OutFile "$env:GITHUB_WORKSPACE/AudioPlayerApi.zip"
          Expand-Archive -Path "$env:GITHUB_WORKSPACE/AudioPlayerApi.zip" -DestinationPath "$env:GITHUB_WORKSPACE/AudioPlayerApi"

          Get-ChildItem "$env:GITHUB_WORKSPACE/AudioPlayerApi/dependencies" -Filter *.dll | ForEach-Object {
            $target = Join-Path $env:EXILED_REFERENCES $_.Name
            if (-not (Test-Path $target)) { Copy-Item $_.FullName $target }
          }

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build plugin
        run: msbuild ${{ matrix.plugin }} -t:Rebuild -property:Configuration=Release

      - name: Get plugin name
        id: plugin-name
        shell: pwsh
        run: |
          $pluginPath = "${{ matrix.plugin }}"
          $pluginName = [System.IO.Path]::GetFileNameWithoutExtension($pluginPath)
          echo "name=$pluginName" >> $env:GITHUB_OUTPUT

      - name: Upload DLL as artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.plugin-name.outputs.name }}-dll
          path: ${{ steps.plugin-name.outputs.name }}/bin/Release/**/${{ steps.plugin-name.outputs.name }}.dll

  build-frontend:
    name: ðŸ”¨ Build Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build shared types
        working-directory: types
        run: npm install && npm run build

      - name: Install dependencies
        run: npm install

      - name: Build (dev)
        if: github.ref == 'refs/heads/dev'
        run: npm run build:dev

      - name: Build (prod)
        if: github.ref == 'refs/heads/main'
        run: npm run build

  build-backend:
    name: ðŸ”¨ Build Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Build shared types
        working-directory: types
        run: npm install && npm run build

      - name: Install dependencies
        run: npm install

      - name: Prepare environment
        run: cp .env.example .env

      - name: Verify Wrangler types (dev)
        if: github.ref == 'refs/heads/dev'
        run: npx wrangler types -e dev

      - name: Verify Wrangler types (prod)
        if: github.ref == 'refs/heads/main'
        run: npx wrangler types -e production

      - name: Test build with code schema
        run: npx tsc

      - name: Pull real database schema
        run: |
          NODE_ENV=production npx drizzle-kit pull
          sed -i 's/\\"1970-01-01T00:00:00.000Z\\"/0/g' drizzle/schema.ts

      - name: Test build with real schema
        run: |
          mv src/db/schema.ts src/db/schema.ts.back
          cp drizzle/schema.ts src/db/schema.ts
          npx tsc
          mv src/db/schema.ts.back src/db/schema.ts

      - name: Final build
        run: npx tsc

  build-overwatch:
    name: ðŸ”¨ Build Overwatch
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v2

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: overwatch/Dockerfile
          push: false
          tags: zeitvertreib-overwatch:test

  # ============================================
  # DEPLOY JOBS - Only run if ALL builds succeed
  # ============================================

  deploy-frontend:
    name: ðŸš€ Deploy Frontend
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend, build-overwatch, build-plugins]
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: frontend
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build shared types
        working-directory: types
        run: npm install && npm run build

      - name: Install dependencies
        run: npm install

      - name: Build (dev)
        if: github.ref == 'refs/heads/dev'
        run: npm run build:dev

      - name: Build (prod)
        if: github.ref == 'refs/heads/main'
        run: npm run build

      - name: Deploy to Cloudflare (dev)
        if: github.ref == 'refs/heads/dev'
        run: npx wrangler deploy -e dev

      - name: Deploy to Cloudflare (prod)
        if: github.ref == 'refs/heads/main'
        run: npx wrangler deploy -e production

  deploy-backend:
    name: ðŸš€ Deploy Backend
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend, build-overwatch, build-plugins]
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: backend
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Build shared types
        working-directory: types
        run: npm install && npm run build

      - name: Install dependencies
        run: npm install

      - name: Prepare environment
        run: cp .env.example .env

      - name: Build
        run: npx tsc

      - name: Deploy to Cloudflare (dev)
        if: github.ref == 'refs/heads/dev'
        run: npx wrangler deploy -e dev

      - name: Deploy to Cloudflare (prod)
        if: github.ref == 'refs/heads/main'
        run: npx wrangler deploy -e production

  deploy-overwatch:
    name: ðŸš€ Deploy Overwatch
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend, build-overwatch, build-plugins]
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: tags
        run: |
          OWNER=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          IMG="ghcr.io/${OWNER}/zeitvertreib-overwatch"

          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "tags=$IMG:latest" >> $GITHUB_OUTPUT
          else
            echo "tags=$IMG:${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: overwatch/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}

  create-release:
    name: ðŸ“¦ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, deploy-overwatch]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Download all plugin artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Determine version tag
        id: version
        run: |
          # Get the latest build number
          git fetch --tags
          LATEST_TAG=$(git tag -l "build-*" --sort=-v:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            BUILD_NUMBER=1
          else
            # Extract number from build-XXX
            BUILD_NUMBER=${LATEST_TAG#build-}
            BUILD_NUMBER=$((BUILD_NUMBER + 1))
          fi

          NEW_TAG="build-${BUILD_NUMBER}"

          echo "Latest tag: $LATEST_TAG"
          echo "New tag: $NEW_TAG"
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "previous_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          mkdir -p release-assets
          find artifacts -name "*.dll" -exec cp {} release-assets/ \;
          ls -lah release-assets/

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Build ${{ steps.version.outputs.build_number }}
          draft: true
          files: release-assets/*.dll
          make_latest: true
          generate_release_notes: true

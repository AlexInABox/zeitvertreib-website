name: Build and Deploy (Production)

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  # ============================================
  # BUILD JOBS - Run in parallel to verify all builds pass
  # ============================================

  build-types:
    name: ðŸ”¨ Build Types
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: types

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: types/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Upload types artifact
        uses: actions/upload-artifact@v6
        with:
          name: types-dist
          path: types/dist/

  discover-plugins:
    name: ðŸ” Discover C# Plugins
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      projects: ${{ steps.set-projects.outputs.projects }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Find all csproj files (excluding root)
        id: set-projects
        run: |
          projects=$(find . -mindepth 2 -name "*.csproj" -printf '%P\n' | jq -R -s -c 'split("\n")[:-1]')
          echo "projects=$projects" >> $GITHUB_OUTPUT

  build-plugins:
    name: ðŸ”¨ Build C# Plugin
    needs: [build-types, discover-plugins]
    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJson(needs.discover-plugins.outputs.projects) }}
    uses: ./.github/workflows/build-plugin-reusable.yml
    with:
      plugin: ${{ matrix.plugin }}

  build-frontend:
    name: ðŸ”¨ Build Frontend
    runs-on: ubuntu-latest
    needs: [build-types]
    timeout-minutes: 15
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build shared types
        working-directory: types
        run: npm install && npm run build

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

  build-backend:
    name: ðŸ”¨ Build Backend
    runs-on: ubuntu-latest
    needs: [build-types]
    timeout-minutes: 15
    defaults:
      run:
        working-directory: backend
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Build shared types
        working-directory: types
        run: npm install && npm run build

      - name: Install dependencies
        run: npm install

      - name: Prepare environment
        run: cp .env.example .env

      - name: Verify Wrangler types
        run: npx wrangler types -e production

      - name: Test build with code schema
        run: npx tsc

      - name: Pull real database schema
        run: NODE_ENV=production npx drizzle-kit pull

      - name: Test build with real schema
        run: |
          mv src/db/schema.ts src/db/schema.ts.back
          cp drizzle/schema.ts src/db/schema.ts
          npx tsc
          mv src/db/schema.ts.back src/db/schema.ts

      - name: Final build
        run: npx tsc

  build-overwatch:
    name: ðŸ”¨ Build Overwatch
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v2

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: overwatch/Dockerfile
          push: false
          tags: zeitvertreib-overwatch:test

  # ============================================
  # DEPLOY JOBS - Only run if ALL builds succeed
  # ============================================

  deploy-frontend:
    name: ðŸš€ Deploy Frontend
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend, build-overwatch, build-plugins]
    timeout-minutes: 15
    defaults:
      run:
        working-directory: frontend
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build shared types
        working-directory: types
        run: npm install && npm run build

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Deploy to Cloudflare
        run: npx wrangler deploy -e production

  deploy-backend:
    name: ðŸš€ Deploy Backend
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend, build-overwatch, build-plugins]
    timeout-minutes: 15
    defaults:
      run:
        working-directory: backend
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: 1a27efaacb5e2b77fcaec04e0f6b0a0b

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Build shared types
        working-directory: types
        run: npm install && npm run build

      - name: Install dependencies
        run: npm install

      - name: Prepare environment
        run: cp .env.example .env

      - name: Build
        run: npx tsc

      - name: Deploy to Cloudflare (prod)
        run: npx wrangler deploy -e production

  deploy-overwatch:
    name: ðŸš€ Deploy Overwatch
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend, build-overwatch, build-plugins]
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v2

      - id: downcase
        name: downcase REPO_OWNER
        run: |
          OWNER=${GITHUB_REPOSITORY%%/*}
          echo "REPO_OWNER=${OWNER,,}" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ steps.downcase.outputs.REPO_OWNER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: tags
        run: |
          OWNER=${{ steps.downcase.outputs.REPO_OWNER }}
          IMG="ghcr.io/${OWNER}/zeitvertreib-overwatch"

          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "tags=$IMG:latest" >> $GITHUB_OUTPUT
          else
            echo "tags=$IMG:${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: overwatch/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}

  create-release:
    name: ðŸ“¦ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, deploy-overwatch]
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Download all plugin artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Determine version tag
        id: version
        run: |
          # Get the latest build number
          git fetch --tags
          LATEST_TAG=$(git tag -l "build-*" --sort=-v:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            BUILD_NUMBER=1
          else
            # Extract number from build-XXX
            BUILD_NUMBER=${LATEST_TAG#build-}
            BUILD_NUMBER=$((BUILD_NUMBER + 1))
          fi

          NEW_TAG="build-${BUILD_NUMBER}"

          echo "Latest tag: $LATEST_TAG"
          echo "New tag: $NEW_TAG"
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "previous_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          mkdir -p release-assets
          find artifacts -name "*.dll" -exec cp {} release-assets/ \;
          ls -lah release-assets/

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Build ${{ steps.version.outputs.build_number }}
          draft: true
          files: release-assets/*.dll
          make_latest: true
          generate_release_notes: true

<div class="accounting-container">
  <!-- Financial Overview Grid -->
  <div class="financial-overview-grid">
    <!-- Quick Stats Cards -->
    <div class="quick-stats-section">
      <h2 class="section-title">Finanz√ºbersicht</h2>
      
      <!-- Admin Controls -->
      <div *ngIf="isAdmin" class="admin-controls">
        <button 
          class="admin-btn add-transaction-btn"
          (click)="openAddTransactionModal()"
        >
          <i class="pi pi-plus"></i>
          Transaktion hinzuf√ºgen
        </button>
        <button 
          class="admin-btn add-recurring-btn"
          (click)="openAddRecurringModal()"
        >
          <i class="pi pi-refresh"></i>
          Wiederkehrend hinzuf√ºgen
        </button>
        <span class="admin-badge">Admin</span>
      </div>

      <div class="stats-grid">
        <!-- Balance Card -->
        <div
          class="stat-card balance-card"
          [class.negative]="currentBalance < 0"
          [class.showing-help]="showSaldoHelp"
        >
          <!-- Help Popup -->
          <div *ngIf="showSaldoHelp" class="help-popup">
            <div class="help-content">
              <div class="help-title">
                Server-Saldo - Finanzielle Gesundheit der Community! üí∞
              </div>
              <div class="help-text">
                Der aktuelle Server-Saldo zeigt die Gesamtbilanz aller Einnahmen
                und Ausgaben f√ºr den Zeitvertreib Community Server seit Beginn
                der Aufzeichnungen.
              </div>
              <div class="help-text">
                <strong>Berechnung:</strong><br />
                ‚Ä¢ Alle Einnahmen (Community-Spenden, Merchandise, etc.)<br />
                ‚Ä¢ Minus alle Ausgaben (Server-Hosting, Domains, Services,
                etc.)<br />
                ‚Ä¢ = Aktueller Server-Saldo
              </div>
              <div class="help-text">
                <strong>Positiver Saldo:</strong> Die Community hat mehr
                gespendet als f√ºr den Server ausgegeben wurde<br />
                <strong>Negativer Saldo:</strong> Die Server-Kosten √ºbersteigen
                die Community-Unterst√ºtzung
              </div>
              <button (click)="showSaldoHelp = false" class="help-close-btn">
                Verstanden! ‚ú®
              </button>
            </div>
          </div>

          <!-- Regular Card Content -->
          <div *ngIf="!showSaldoHelp">
            <div class="stat-header">
              <i class="pi pi-wallet stat-icon"></i>
              <div class="stat-header-content">
                <span class="stat-label">Server-Saldo</span>
                <button
                  (click)="showSaldoHelp = true"
                  class="help-button"
                  title="Hilfe anzeigen"
                >
                  ?
                </button>
              </div>
            </div>
            <div class="stat-value">
              <span class="currency-symbol">‚Ç¨</span>
              <span class="amount">{{
                currentBalance | number : "1.2-2"
              }}</span>
            </div>
            <div
              class="stat-trend"
              [class.positive]="currentBalance >= 0"
              [class.negative]="currentBalance < 0"
            >
              <i
                class="pi"
                [class.pi-arrow-up]="currentBalance >= 0"
                [class.pi-arrow-down]="currentBalance < 0"
              ></i>
              <span>{{ currentBalance >= 0 ? "√úberschuss" : "Defizit" }}</span>
            </div>
          </div>
        </div>

        <!-- Monthly Income -->
        <div class="stat-card income-card">
          <div class="stat-header">
            <i class="pi pi-arrow-up-right stat-icon"></i>
            <span class="stat-label">Community-Einnahmen</span>
          </div>
          <div class="stat-value">
            <span class="currency-symbol">‚Ç¨</span>
            <span class="amount">{{ monthlyIncome | number : "1.2-2" }}</span>
          </div>
          <div class="stat-info">
            <span>√ò {{ averageMonthlyIncome | number : "1.2-2" }}‚Ç¨/Monat</span>
          </div>
        </div>

        <!-- Monthly Expenses -->
        <div class="stat-card expense-card">
          <div class="stat-header">
            <i class="pi pi-arrow-down-right stat-icon"></i>
            <span class="stat-label">Server-Ausgaben</span>
          </div>
          <div class="stat-value">
            <span class="currency-symbol">‚Ç¨</span>
            <span class="amount">{{ monthlyExpenses | number : "1.2-2" }}</span>
          </div>
          <div class="stat-info">
            <span
              >√ò {{ averageMonthlyExpenses | number : "1.2-2" }}‚Ç¨/Monat</span
            >
          </div>
        </div>

        <!-- Coverage Progress -->
        <div
          class="stat-card coverage-card"
          [class.showing-help]="showCoverageHelp"
        >
          <!-- Help Popup -->
          <div *ngIf="showCoverageHelp" class="help-popup">
            <div class="help-content">
              <div class="help-title">
                Server-Kostendeckung - Wie gut unterst√ºtzt die Community? üìä
              </div>
              <div class="help-text">
                Die Server-Kostendeckung zeigt, wie gut die Community-Einnahmen
                die laufenden Server-Kosten decken k√∂nnen.
              </div>
              <div class="help-text">
                <strong>Berechnung:</strong><br />
                ‚Ä¢ Durchschnittliche monatliche Community-Einnahmen<br />
                ‚Ä¢ Geteilt durch durchschnittliche monatliche Server-Ausgaben<br />
                ‚Ä¢ Multipliziert mit 100 = Deckungsgrad
              </div>
              <div class="help-text">
                <strong>100% oder mehr:</strong> Community-Unterst√ºtzung deckt
                alle Server-Kosten ab<br />
                <strong>Unter 100%:</strong> Server-Kosten sind h√∂her als
                Community-Einnahmen<br />
                <strong>√úber 100%:</strong> Die Community unterst√ºtzt sogar √ºber
                die Kosten hinaus! üéâ
              </div>
              <button (click)="showCoverageHelp = false" class="help-close-btn">
                Verstanden! ‚ú®
              </button>
            </div>
          </div>

          <!-- Regular Card Content -->
          <div *ngIf="!showCoverageHelp">
            <div class="stat-header">
              <i class="pi pi-chart-line stat-icon"></i>
              <div class="stat-header-content">
                <span class="stat-label">Server-Kostendeckung</span>
                <button
                  (click)="showCoverageHelp = true"
                  class="help-button"
                  title="Hilfe anzeigen"
                >
                  ?
                </button>
              </div>
            </div>
            <div class="coverage-progress">
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  [style.width.%]="coveragePercentage"
                ></div>
              </div>
              <div class="progress-text">
                <span class="percentage">{{ coveragePercentage }}%</span>
                <span
                  class="coverage-status"
                  [class.covered]="coveragePercentage >= 100"
                >
                  {{
                    coveragePercentage >= 100
                      ? "Vollst√§ndig gedeckt"
                      : "Unterdeckt"
                  }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Transactions -->
    <div class="transactions-section">
      <div class="section-header">
        <h2 class="section-title">Server-Transaktionen</h2>
        <div class="transaction-filters">
          <button class="filter-btn active" (click)="filterTransactions('all')">
            Alle
          </button>
          <button class="filter-btn" (click)="filterTransactions('income')">
            Community-Support
          </button>
          <button class="filter-btn" (click)="filterTransactions('expenses')">
            Server-Kosten
          </button>
        </div>
      </div>

      <div class="transactions-list">
        <div
          class="transaction-item"
          *ngFor="let event of filteredEvents"
          [class.income]="event.type === 'income'"
          [class.expense]="event.type === 'expense'"
        >
          <div class="transaction-icon">
            <i [class]="event.icon"></i>
          </div>
          <div class="transaction-details">
            <div class="transaction-main">
              <span class="service-name">{{ event.service }}</span>
              <span
                class="transaction-amount"
                [class.positive]="event.type === 'income'"
                [class.negative]="event.type === 'expense'"
              >
                {{ event.type === "income" ? "+" : "-" }}‚Ç¨{{
                  event.amount | number : "1.2-2"
                }}
              </span>
            </div>
            <div class="transaction-meta">
              <span class="description">{{ event.description }}</span>
              <span class="date">{{ event.date | date : "dd.MM.yyyy" }}</span>
            </div>
          </div>
          
          <!-- Admin Controls for each transaction -->
          <div *ngIf="isAdmin" class="transaction-admin-controls">
            <button 
              class="admin-btn edit-btn"
              (click)="editTransaction(event)"
              title="Bearbeiten"
            >
              <i class="pi pi-pencil"></i>
            </button>
            <button 
              class="admin-btn delete-btn"
              (click)="deleteTransaction(event)"
              title="L√∂schen"
            >
              <i class="pi pi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recurring Transactions Section -->
    <div *ngIf="isAdmin && recurringTransactions.length > 0" class="recurring-transactions-section">
      <h3 class="section-title">Wiederkehrende Transaktionen</h3>
      
      <div class="recurring-transactions-list">
        <div
          class="recurring-transaction-item"
          *ngFor="let recurring of recurringTransactions"
          [class.income]="recurring.transaction_type === 'income'"
          [class.expense]="recurring.transaction_type === 'expense'"
          [class.inactive]="!recurring.is_active"
        >
          <div class="recurring-icon">
            <i class="pi pi-refresh"></i>
          </div>
          <div class="recurring-details">
            <div class="recurring-main">
              <span class="recurring-service">{{ recurring.category }}</span>
              <span class="recurring-frequency">{{ recurring.frequency }}</span>
              <span
                class="recurring-amount"
                [class.positive]="recurring.transaction_type === 'income'"
                [class.negative]="recurring.transaction_type === 'expense'"
              >
                {{ recurring.transaction_type === "income" ? "+" : "-" }}‚Ç¨{{
                  recurring.amount | number : "1.2-2"
                }}
              </span>
            </div>
            <div class="recurring-meta">
              <span class="recurring-description">{{ recurring.description }}</span>
              <span class="recurring-next">N√§chste Ausf√ºhrung: {{ recurring.next_execution | date : "dd.MM.yyyy" }}</span>
            </div>
          </div>
          
          <!-- Admin Controls for recurring transactions -->
          <div class="recurring-admin-controls">
            <button 
              class="admin-btn edit-btn"
              (click)="editRecurringTransaction(recurring)"
              title="Bearbeiten"
            >
              <i class="pi pi-pencil"></i>
            </button>
            <button 
              class="admin-btn delete-btn"
              (click)="deleteRecurringTransaction(recurring)"
              title="L√∂schen"
            >
              <i class="pi pi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Monthly Breakdown -->
    <div class="monthly-breakdown-section">
      <h2 class="section-title">Monatliche Server-Finanz√ºbersicht</h2>

      <div class="breakdown-grid">
        <div class="breakdown-item" *ngFor="let month of monthlyBreakdown">
          <div class="month-header">
            <span class="month-name">{{ month.name }}</span>
            <span
              class="month-balance"
              [class.positive]="month.balance >= 0"
              [class.negative]="month.balance < 0"
            >
              {{ month.balance >= 0 ? "+" : "" }}‚Ç¨{{
                month.balance | number : "1.2-2"
              }}
            </span>
          </div>
          <div class="month-details">
            <div class="detail-row">
              <span class="label">Community-Support:</span>
              <span class="value positive"
                >+‚Ç¨{{ month.income | number : "1.2-2" }}</span
              >
            </div>
            <div class="detail-row">
              <span class="label">Server-Kosten:</span>
              <span class="value negative"
                >-‚Ç¨{{ month.expenses | number : "1.2-2" }}</span
              >
            </div>
          </div>
          <div class="month-progress">
            <div class="progress-bar small">
              <div
                class="progress-fill"
                [style.width.%]="month.coveragePercentage"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Projections -->
    <div class="projections-section">
      <h2 class="section-title">Server-Finanzprognose</h2>

      <div class="projection-cards">
        <div class="projection-card">
          <div class="projection-header">
            <i class="pi pi-calendar stat-icon"></i>
            <span class="projection-label">N√§chste 3 Monate</span>
          </div>
          <div
            class="projection-value"
            [class.positive]="threeMonthProjection >= 0"
            [class.negative]="threeMonthProjection < 0"
          >
            {{ threeMonthProjection >= 0 ? "+" : "" }}‚Ç¨{{
              threeMonthProjection | number : "1.2-2"
            }}
          </div>
          <div class="projection-info">
            <span>Basierend auf aktuellen Durchschnittswerten</span>
          </div>
        </div>

        <div class="projection-card">
          <div class="projection-header">
            <i class="pi pi-clock stat-icon"></i>
            <span class="projection-label">Server-Laufzeit</span>
          </div>
          <div class="projection-value">
            {{ burnRate | number : "1.2-2" }} Monate
          </div>
          <div class="projection-info">
            <span>Bei aktuellem Saldo und Server-Kosten</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Modal -->
<div *ngIf="showTransactionModal" class="modal-overlay" (click)="closeTransactionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingTransaction ? 'Transaktion bearbeiten' : 'Neue Transaktion hinzuf√ºgen' }}</h3>
      <button class="modal-close-btn" (click)="closeTransactionModal()">
        <i class="pi pi-times"></i>
      </button>
    </div>
    
    <form class="transaction-form" (ngSubmit)="saveTransaction()" #transactionForm="ngForm">
      <div class="form-group">
        <label for="transactionType">Typ *</label>
        <select 
          id="transactionType"
          [(ngModel)]="transactionFormData.type"
          name="type"
          required
          class="form-control"
        >
          <option value="">Typ ausw√§hlen</option>
          <option value="income">Einnahme</option>
          <option value="expense">Ausgabe</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="category">Kategorie *</label>
        <select 
          id="category"
          [(ngModel)]="transactionFormData.category"
          name="category"
          required
          class="form-control"
        >
          <option value="">Kategorie ausw√§hlen</option>
          <option value="hosting">Server-Hosting</option>
          <option value="domain">Domain</option>
          <option value="services">Services</option>
          <option value="donation">Spende</option>
          <option value="merchandise">Merchandise</option>
          <option value="other">Sonstiges</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="amount">Betrag (‚Ç¨) *</label>
        <input 
          type="number"
          id="amount"
          [(ngModel)]="transactionFormData.amount"
          name="amount"
          required
          step="0.01"
          min="0"
          class="form-control"
          placeholder="0.00"
        />
      </div>
      
      <div class="form-group">
        <label for="description">Beschreibung *</label>
        <input 
          type="text"
          id="description"
          [(ngModel)]="transactionFormData.description"
          name="description"
          required
          class="form-control"
          placeholder="Beschreibung der Transaktion"
        />
      </div>
      
      <div class="form-group">
        <label for="date">Datum *</label>
        <input 
          type="date"
          id="date"
          [(ngModel)]="transactionFormData.date"
          name="date"
          required
          class="form-control"
        />
      </div>
      
      <div class="form-group">
        <label for="service">Service</label>
        <input 
          type="text"
          id="service"
          [(ngModel)]="transactionFormData.service"
          name="service"
          class="form-control"
          placeholder="Service oder Anbieter"
        />
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeTransactionModal()">
          Abbrechen
        </button>
        <button 
          type="submit" 
          class="btn btn-primary"
          [disabled]="!transactionForm.valid || isSubmitting"
        >
          <i class="pi pi-spin pi-spinner" *ngIf="isSubmitting"></i>
          {{ editingTransaction ? 'Speichern' : 'Hinzuf√ºgen' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Recurring Transaction Modal -->
<div *ngIf="showRecurringModal" class="modal-overlay" (click)="closeRecurringModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingRecurring ? 'Wiederkehrende Transaktion bearbeiten' : 'Neue wiederkehrende Transaktion hinzuf√ºgen' }}</h3>
      <button class="modal-close-btn" (click)="closeRecurringModal()">
        <i class="pi pi-times"></i>
      </button>
    </div>
    
    <form class="transaction-form" (ngSubmit)="saveRecurringTransaction()" #recurringForm="ngForm">
      <div class="form-group">
        <label for="recurringType">Typ *</label>
        <select 
          id="recurringType"
          [(ngModel)]="recurringFormData.type"
          name="type"
          required
          class="form-control"
        >
          <option value="">Typ ausw√§hlen</option>
          <option value="income">Einnahme</option>
          <option value="expense">Ausgabe</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="recurringCategory">Kategorie *</label>
        <select 
          id="recurringCategory"
          [(ngModel)]="recurringFormData.category"
          name="category"
          required
          class="form-control"
        >
          <option value="">Kategorie ausw√§hlen</option>
          <option value="hosting">Server-Hosting</option>
          <option value="domain">Domain</option>
          <option value="services">Services</option>
          <option value="donation">Spende</option>
          <option value="merchandise">Merchandise</option>
          <option value="other">Sonstiges</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="recurringAmount">Betrag (‚Ç¨) *</label>
        <input 
          type="number"
          id="recurringAmount"
          [(ngModel)]="recurringFormData.amount"
          name="amount"
          required
          step="0.01"
          min="0"
          class="form-control"
          placeholder="0.00"
        />
      </div>
      
      <div class="form-group">
        <label for="recurringDescription">Beschreibung *</label>
        <input 
          type="text"
          id="recurringDescription"
          [(ngModel)]="recurringFormData.description"
          name="description"
          required
          class="form-control"
          placeholder="Beschreibung der wiederkehrenden Transaktion"
        />
      </div>
      
      <div class="form-group">
        <label for="recurringFrequency">H√§ufigkeit *</label>
        <select 
          id="recurringFrequency"
          [(ngModel)]="recurringFormData.frequency"
          name="frequency"
          required
          class="form-control"
        >
          <option value="">H√§ufigkeit ausw√§hlen</option>
          <option value="daily">T√§glich</option>
          <option value="weekly">W√∂chentlich</option>
          <option value="monthly">Monatlich</option>
          <option value="yearly">J√§hrlich</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="recurringStartDate">Startdatum *</label>
        <input 
          type="date"
          id="recurringStartDate"
          [(ngModel)]="recurringFormData.start_date"
          name="start_date"
          required
          class="form-control"
        />
      </div>
      
      <div class="form-group">
        <label for="recurringEndDate">Enddatum (optional)</label>
        <input 
          type="date"
          id="recurringEndDate"
          [(ngModel)]="recurringFormData.end_date"
          name="end_date"
          class="form-control"
        />
      </div>
      
      <div class="form-group">
        <label for="recurringService">Service</label>
        <input 
          type="text"
          id="recurringService"
          [(ngModel)]="recurringFormData.service"
          name="service"
          class="form-control"
          placeholder="Service oder Anbieter"
        />
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeRecurringModal()">
          Abbrechen
        </button>
        <button 
          type="submit" 
          class="btn btn-primary"
          [disabled]="!recurringForm.valid || isSubmitting"
        >
          <i class="pi pi-spin pi-spinner" *ngIf="isSubmitting"></i>
          {{ editingRecurring ? 'Speichern' : 'Hinzuf√ºgen' }}
        </button>
      </div>
    </form>
  </div>
</div>
